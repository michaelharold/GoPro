<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bus Selection</title>
<link rel="stylesheet" href="/css/styles.css">
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  h2 { margin-bottom: 20px; }
  ul { list-style-type: none; padding: 0; }
  li { padding: 10px; border: 1px solid #ccc; margin-bottom: 10px; cursor: pointer; border-radius: 5px; }
  li.selected { background-color: #d0f0c0; }
  button { margin-top: 20px; padding: 10px 20px; }
</style>
</head>
<body>
<h2>Available Buses</h2>
<div id="busList"></div>
<button id="proceedBtn" disabled>Proceed to Booking</button>

<script>
const urlParams = new URLSearchParams(window.location.search);
const budget = parseFloat(urlParams.get('budget'));
const from = urlParams.get('from');
const to = urlParams.get('to');
const date = urlParams.get('date');

let selectedBus = null;

async function fetchBuses() {
  try {
    const res = await fetch(`/api/buses?budget=${budget}&from=${from}&to=${to}&date=${date}`);
    if (!res.ok) throw new Error('Failed to fetch buses');
    const buses = await res.json();
    const busListDiv = document.getElementById('busList');

    if (!buses || buses.length === 0) {
      busListDiv.innerHTML = `<p>No buses available within your budget.</p>`;
      return;
    }

    let html = '<ul>';
    buses.forEach((bus, index) => {
      html += `<li data-index="${index}">${bus.name} | From: ${bus.from} | To: ${bus.to} | Date: ${bus.date} | Price: â‚¹${bus.price}</li>`;
    });
    html += '</ul>';
    busListDiv.innerHTML = html;

    // Add click events to select a bus
    const listItems = busListDiv.querySelectorAll('li');
    listItems.forEach(li => {
      li.addEventListener('click', () => {
        listItems.forEach(item => item.classList.remove('selected'));
        li.classList.add('selected');
        selectedBus = buses[li.dataset.index];
        document.getElementById('proceedBtn').disabled = false;
      });
    });

  } catch (err) {
    console.error(err);
    alert('Error fetching buses.');
  }
}

document.getElementById('proceedBtn').addEventListener('click', () => {
  if (!selectedBus) return;
  // Redirect to a booking page with selected bus details
  window.location.href = `/bus_booking.html?busName=${encodeURIComponent(selectedBus.name)}&from=${selectedBus.from}&to=${selectedBus.to}&date=${selectedBus.date}&price=${selectedBus.price}`;
});

fetchBuses();
</script>
</body>
</html>