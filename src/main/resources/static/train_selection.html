<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Train Selection</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    body { font-family: 'Nunito', sans-serif; background: linear-gradient(to bottom, #0a0a0f 15%, #1a1533 45%, #3b2a84 90%); color: #e0d7f5; padding: 20px; min-height: 100vh; }
    h2 { text-align: center; margin-bottom: 20px; font-size: 2.5rem; font-weight: 800; color: #d1c4e9; }
    .d-flex { display: flex; gap: 20px; }
    #sidebar { width: 250px; padding: 25px; background: linear-gradient(145deg, #1e1e2f, #2b2250); border-radius: 12px; color: #e0d7f5; font-weight: 600; }
    #sidebar h5 { text-align: center; font-size: 1.5rem; font-weight: 700; margin-bottom: 15px; color: #d1c4e9; }
    #sidebar label { display: block; font-size: 1rem; color: #d1c4e9; margin-bottom: 12px; }
    #sidebar input, #sidebar select, #sidebar input[type='range'] { width: 100%; background: #5e35b1; border: none; color: #e0d7f5; font-weight: 600; border-radius: 6px; box-shadow: inset 0 0 5px rgba(186,104,200,0.5); margin-bottom: 12px; padding: 6px 10px; }
    #sidebar input:focus, #sidebar select:focus, #sidebar input[type='range']:focus { background: #7e57c2; outline: none; color: #fff; }
    #splitLabel { font-weight: 700; color: #d1c4e9; margin-left: 6px; }
    #trains-container { flex: 1; display: flex; flex-direction: column; gap: 20px; }
    .card { width: 100%; border-radius: 23px; background: linear-gradient(145deg, #1e1e2f, #2b2250); color: #e0d7f5; box-shadow: 0 0 25px rgba(87,74,211,0.25); padding: 40px; display: flex; flex-direction: column; transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .card:hover { transform: scale(1.03); box-shadow: 0 0 35px rgba(90,79,207,0.45); }
    .train-name { font-size: 1.8rem; font-weight: 800; text-align: center; margin-bottom: 15px; color: #d1c4e9; }
    .train-detail {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.3rem;
      font-weight: 700;
      color: #e0d7f5;
      gap: 32px;
      /* Removed inner border, background, box-shadow, and padding to unify card appearance */
      margin-bottom: 0;
      border: none;
      border-radius: 0;
      padding: 0;
      background: none;
      box-shadow: none;
    }
    .btn-select { background: linear-gradient(145deg,#5b47c7,#4632a2); border: none; border-radius: 25px; padding: 12px 35px; font-weight: 600; font-size: 15px; width: 50%; margin: 20px auto 0 auto; display: block; color: #ffffff; transition: 0.25s ease; }
    .btn-select:hover { background: linear-gradient(to top,#7b6df5,#5445c0); box-shadow: 0 4px 12px rgba(75,52,170,0.45); }
  </style>
</head>
<body>

<h2>Available Trains</h2>

<div class="d-flex">
  <div id="sidebar">
    <h5>Preferences</h5>
    <label for="budgetSplit">Budget Split (Travel / Hotel): <span id="splitLabel">70% / 30%</span></label>
    <input type="range" id="budgetSplit" min="0" max="100" value="70" step="5">
    <div class="mb-2 mt-2">
      <label>From:</label>
      <input type="text" id="sidebarFrom" class="form-control" value="">
    </div>
    <div class="mb-2">
      <label>To:</label>
      <input type="text" id="sidebarTo" class="form-control" value="">
    </div>
    <label>Travel Mode:</label>
    <select id="travelMode" class="form-control mb-2">
      <option value="flight">Flight</option>
      <option value="train" selected>Train</option>
      <option value="bus">Bus</option>
    </select>
    <button id="savePrefs" class="btn btn-primary w-100 mt-2">Save Changes</button>
  </div>

  <div id="trains-container"></div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
// Try URL first
let totalBudget = parseFloat(urlParams.get('totalBudget'));

// If not in URL, check sessionStorage
if (!totalBudget) {
  totalBudget = parseFloat(sessionStorage.getItem('totalBudget')) || 50000;
}

// Always save the total budget in sessionStorage for next pages
sessionStorage.setItem('totalBudget', totalBudget);

let budget = parseFloat(urlParams.get('budget')) || totalBudget;
let from = urlParams.get('from') || '';
let to = urlParams.get('to') || '';
let date = urlParams.get('date') || '';
let days = parseInt(urlParams.get('days'), 10) || 1;

document.getElementById('sidebarFrom').value = from;
document.getElementById('sidebarTo').value = to;

document.getElementById('budgetSplit').addEventListener('input', e => {
  const travelPct = e.target.value;
  document.getElementById('splitLabel').textContent = `${travelPct}% / ${100 - travelPct}%`;
});

document.getElementById('savePrefs').addEventListener('click', () => {
  const split = parseInt(document.getElementById('budgetSplit').value);
  const travelBudget = totalBudget * (split / 100);
  const hotelBudget = totalBudget - travelBudget;
  const newFrom = document.getElementById('sidebarFrom').value.trim();
  const newTo = document.getElementById('sidebarTo').value.trim();
  const travelMode = document.getElementById('travelMode').value;

  window.location.href = `/${travelMode}_selection.html?budget=${travelBudget}&from=${encodeURIComponent(newFrom)}&to=${encodeURIComponent(newTo)}&date=${date}&days=${days}&accommodationBudget=${hotelBudget}`;

});

async function loadTrains() {
  const container = document.getElementById('trains-container');
  container.innerHTML = '';

  try {
    const travelBudget = budget * (parseInt(document.getElementById('budgetSplit').value)/100);
    const response = await fetch(`/api/trains?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&date=${encodeURIComponent(date)}&budget=${travelBudget}`);
    const trains = await response.json();

    if (!trains || trains.length === 0) {
      container.innerHTML = `<p class="text-center mt-4">No trains available within your budget</p>`;
      return;
    }

    trains.forEach(t => {
      const card = document.createElement('div');
      card.className = 'card mb-3';
      card.innerHTML = `
        <div class="train-detail">
          <div>${t.from} → ${t.to}</div>
          <div>${t.name}</div>
          <div>₹${t.price}</div>
        </div>
        <button class="btn-select" onclick="confirmTrain('${t.name}', '${t.from}', '${t.to}', ${t.price})"> Available Trains </button>
      `;
      container.appendChild(card);
    });

  } catch(err) {
    console.error(err);
    container.innerHTML = `<p class="text-center mt-4">Error fetching trains</p>`;
  }
}

function confirmTrain(name, fromTrain, toTrain, price) {
  const travelPct = parseInt(document.getElementById('budgetSplit').value);
  const travelBudget = budget * (travelPct / 100);
  const hotelBudget = budget - travelBudget;
  const remaining = travelBudget - price + hotelBudget;

  if (remaining <= 0) {
    alert("This train exceeds your total travel budget!");
    return;
  }

  alert(`Train booked successfully!\n${name}\n₹${price}\nRemaining budget for hotel: ₹${remaining.toFixed(2)}`);
 window.location.href = `/hotel_selection.html?to=${encodeURIComponent(to)}&days=${days}&date=${date}&budget=${remaining.toFixed(2)}` +
                        `&transportType=train&transportName=${encodeURIComponent(name)}&transportPrice=${price}&from=${encodeURIComponent(fromTrain)}`;

}

window.onload = loadTrains;
</script>
</body>
</html>