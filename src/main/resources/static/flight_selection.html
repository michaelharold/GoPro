<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flight Selection</title>
<link rel="stylesheet" href="/css/styles.css">
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  h2 { margin-bottom: 20px; }
  .flight-item { padding: 10px; border: 1px solid #ccc; margin-bottom: 10px; border-radius: 5px; cursor: pointer; }
  .flight-item.selected { background-color: #d0f0c0; }
  button.proceed-btn { margin-top: 20px; padding: 10px 20px; }
</style>
</head>
<body>

<h2>Available Flights</h2>
<div id="flightsList">Loading...</div>
<button class="proceed-btn" id="proceedBtn" disabled>Proceed to Booking</button>

<script>
function getQueryParams() {
    const params = new URLSearchParams(window.location.search);
    return {
        budget: params.get('budget'),
        from: params.get('from'),
        to: params.get('to'),
        date: params.get('date')
    };
}

let selectedFlight = null;

async function fetchFlights() {
    const { budget, from, to, date } = getQueryParams();
    try {
        const res = await fetch(`/api/flights?budget=${budget}&from=${from}&to=${to}&date=${date}`);
        if (!res.ok) throw new Error('Failed to fetch flights');
        const flights = await res.json();
        const container = document.getElementById('flightsList');

        if (!flights || flights.length === 0) {
            container.innerHTML = "<p>No flights available within your budget.</p>";
            return;
        }

        container.innerHTML = flights.map((f, index) => 
            `<div class="flight-item" data-index="${index}">
                <p>${f.airline} | ${f.from} → ${f.to} | Date: ${f.date} | Price: ₹${f.price}</p>
            </div>`
        ).join('');

        const flightItems = container.querySelectorAll('.flight-item');
        flightItems.forEach(item => {
            item.addEventListener('click', () => {
                flightItems.forEach(f => f.classList.remove('selected'));
                item.classList.add('selected');
                selectedFlight = flights[item.dataset.index];
                document.getElementById('proceedBtn').disabled = false;
            });
        });

    } catch (err) {
        console.error(err);
        document.getElementById('flightsList').innerHTML = "<p>Error fetching flights.</p>";
    }
}

document.getElementById('proceedBtn').addEventListener('click', () => {
    if (!selectedFlight) return;
    // Redirect to booking page with selected flight info
    window.location.href = `/flight_booking.html?airline=${encodeURIComponent(selectedFlight.airline)}&from=${selectedFlight.from}&to=${selectedFlight.to}&date=${selectedFlight.date}&price=${selectedFlight.price}`;
});

fetchFlights();
</script>
</body>
</html>